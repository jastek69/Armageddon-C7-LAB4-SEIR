# -------------------------------------------------------------------
# Pairing Notes (AWS side)
# -------------------------------------------------------------------
# This file pairs with `GCP-vpn-aws-tgw-connection.txt`.
# AWS TGW VPN connections generate tunnel outside IPs, and this GCP config
# consumes those IPs in `google_compute_external_vpn_gateway` interfaces.
#
# Keep these values consistent across both sides:
# - Tunnel inside CIDRs (/30)
# - Tunnel pre-shared keys
# - AWS ASN / GCP ASN
# -------------------------------------------------------------------
#
# AWS side of GCP Connection
# Canonical template file:
# - Use this file for AWS TGW <-> GCP VPN blueprint updates.
# 
# -------------------------------------------------------------------
# Architecture Notes: AWS TGW <-> GCP HA VPN
# -------------------------------------------------------------------
# Required on AWS side for GCP connectivity:
# 1) aws_customer_gateway (2) -> one per GCP HA VPN public interface.
# 2) aws_vpn_connection (2) with transit_gateway_id -> each has two tunnels.
# 3) TGW route table association/propagation for VPN attachments.
# 4) Tokyo VPC route tables -> GCP CIDRs routed to TGW.
# 5) Security controls -> allow DB access from approved GCP CIDRs only.
#
# Note: resources not used for GCP integration:
# - aws_ec2_transit_gateway_peering_attachment (AWS TGW-to-TGW only)
# - aws_vpc_peering_connection (VPC peering, not IPSec VPN to GCP)
#
# Where tunnel info belongs:
# - AWS tunnel config goes in aws_vpn_connection:
#   tunnel*_inside_cidr, tunnel*_preshared_key, tunnel params.
# - AWS tunnel outside IPs are generated by AWS and consumed on GCP side.
# - GCP side mirrors the same PSKs and inside CIDRs in VPN tunnel/router blocks.
# -------------------------------------------------------------------


# AWS VPN Setup = Transit Gateway (TGW) + Customer Gateways
# Attaches VPNs to the Tokyo TGW.
# Fill values from Tokyo stack outputs and GCP HA VPN gateway.


# Variables
variable "aws_region" {
  description = "AWS region for TGW (Tokyo)"
  type        = string
  default     = "ap-northeast-1"
}

variable "tgw_id" {
  description = "Tokyo Transit Gateway ID"
  type        = string
  default     = ""
}

variable "aws_side_asn" {
  description = "AWS-side ASN (TGW BGP ASN)"
  type        = number
  default     = 65501
}

variable "gcp_peer_asn" {
  description = "GCP Cloud Router ASN"
  type        = number
  default     = 65515
}

variable "gcp_ha_vpn_public_ip_1" {
  description = "GCP HA VPN gateway interface 0 public IP"
  type        = string
}

variable "gcp_ha_vpn_public_ip_2" {
  description = "GCP HA VPN gateway interface 1 public IP"
  type        = string
}

variable "tunnel1_inside_cidr" { type = string }
variable "tunnel2_inside_cidr" { type = string }
variable "tunnel3_inside_cidr" { type = string }
variable "tunnel4_inside_cidr" { type = string }

variable "psk_tunnel_1" { type = string }
variable "psk_tunnel_2" { type = string }
variable "psk_tunnel_3" { type = string }
variable "psk_tunnel_4" { type = string }

variable "gcp_advertised_cidr" {
  description = "CIDR advertised from GCP Cloud Router toward AWS."
  type        = string
  default     = "10.240.0.0/16"
}

variable "gcp_allowed_db_cidrs" {
  description = "GCP CIDR ranges allowed to reach Tokyo RDS over TGW/VPN."
  type        = list(string)
  default     = ["10.235.0.0/16"]
}

provider "aws" {
  region = var.aws_region
}

data "terraform_remote_state" "tokyo" {
  backend = "s3"
  config = {
    bucket = var.tokyo_state_bucket
    key    = var.tokyo_state_key
    region = var.tokyo_state_region
  }
}


# locals
locals {
  # Allow explicit override, otherwise read TGW ID from Tokyo state.
  effective_tgw_id = var.tgw_id != "" ? var.tgw_id : try(data.terraform_remote_state.tokyo.outputs.tokyo_transit_gateway_id, "")
}

# Security Groups:
- Allow only required DB port from approved GCP CIDR ranges.
- Do not allow 0.0.0.0/0 to database security groups.
- Use the GCP CIDR list variable for least-privilege access.

# Update DB SG - allow GCP CIDRs and Sao Paulo via TGW:
resource "aws_security_group" "tokyo_rds_sg" {
  name        = "tokyo-rds-sg"
  description = "Security group for Tokyo Database instances"
  vpc_id      = aws_vpc.shinjuku_vpc01.id

  # Allow local Tokyo access
  ingress {
    description     = "MySQL from Tokyo EC2"
    from_port       = 3306
    to_port         = 3306
    protocol        = "tcp"
    security_groups = [aws_security_group.tokyo_ec2_app_sg.id]
  }

  # Allow GCP access via TGW/VPN
  ingress {
    description = "MySQL from GCP via TGW VPN"
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = var.gcp_allowed_db_cidrs
  }

  # Allow Sao Paulo access via TGW
  ingress {
    description = "MySQL from Sao Paulo via TGW"
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [var.saopaulo_vpc_cidr]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "tokyo-rds-sg"
  }
}



# AWS Resources

# Customer Gateways - for TGW
# https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/customer_gateway

resource "aws_customer_gateway" "gcp_cgw_1" {
  bgp_asn    = var.gcp_peer_asn
  ip_address = var.gcp_ha_vpn_public_ip_1
  type       = "ipsec.1"
  tags = { Name = "gcp-ha-vpn-if0" }
}

resource "aws_customer_gateway" "gcp_cgw_2" {
  bgp_asn    = var.gcp_peer_asn
  ip_address = var.gcp_ha_vpn_public_ip_2
  type       = "ipsec.1"
  tags = { Name = "gcp-ha-vpn-if1" }
}



# VPN Connections - HA VPN using TGW
# https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpn_connection


# VPN 1 tunnel
resource "aws_vpn_connection" "tgw_vpn_1" {
  transit_gateway_id  = local.effective_tgw_id
  customer_gateway_id = aws_customer_gateway.gcp_cgw_1.id
  type                = "ipsec.1"
  static_routes_only  = false

  tunnel1_inside_cidr   = var.tunnel1_inside_cidr
  tunnel1_preshared_key = var.psk_tunnel_1
  tunnel1_ike_versions  = ["ikev2"]

  tunnel2_inside_cidr   = var.tunnel2_inside_cidr
  tunnel2_preshared_key = var.psk_tunnel_2
  tunnel2_ike_versions  = ["ikev2"]

  tags = { Name = "tgw-to-gcp-vpn-1" }
}

# VPN 2 Tunnel
resource "aws_vpn_connection" "tgw_vpn_2" {
  transit_gateway_id  = local.effective_tgw_id
  customer_gateway_id = aws_customer_gateway.gcp_cgw_2.id
  type                = "ipsec.1"
  static_routes_only  = false

  tunnel1_inside_cidr   = var.tunnel3_inside_cidr
  tunnel1_preshared_key = var.psk_tunnel_3
  tunnel1_ike_versions  = ["ikev2"]

  tunnel2_inside_cidr   = var.tunnel4_inside_cidr
  tunnel2_preshared_key = var.psk_tunnel_4
  tunnel2_ike_versions  = ["ikev2"]

  tags = { Name = "tgw-to-gcp-vpn-2" }
}
==================================================================
SECURITY DETAILS (AWS SIDE) - TGW VPN TO GCP
==================================================================

1) Security Groups (RDS and App)
- Allow only required DB port from approved GCP CIDR ranges.
- Do not allow 0.0.0.0/0 to database security groups.
- Prefer least-privilege SG-to-SG rules where possible.

2) Network ACLs
- Ensure subnet NACLs allow required return traffic for DB sessions.
- Keep NACL rules scoped to known GCP CIDR ranges where feasible.

3) Transit Gateway Route Control
- Only propagate/associate VPN attachments to the required TGW route table.
- Do not leak unrelated VPC CIDRs into GCP.
- Add explicit static routes if you need strict corridor control.

4) VPC Route Tables (Tokyo)
- Add routes for GCP CIDRs to TGW in DB/app subnet route tables.
- Avoid broad routes that permit unexpected east-west movement.

5) IPSec/BGP Tunnel Hardening
- Use strong PSKs and rotate periodically.
- Keep tunnel inside CIDRs unique and non-overlapping.
- Keep AWS ASN and GCP ASN explicit and documented.

6) IAM and Secrets
- Do not hardcode PSKs in committed Terraform files.
- Store secrets in secure variables/secrets manager and inject at apply time.
- Restrict IAM principals that can read/modify VPN/TGW resources.

7) Logging and Audit
- Enable and retain CloudTrail management events for TGW/VPN changes.
- Enable VPC Flow Logs on relevant subnets for path verification.
- Capture evidence of TGW route table, VPN health, and route propagation.

8) Operational Guardrails
- Use alarms for tunnel down/BGP down events.
- Define change windows and rollback steps for route/security updates.
- Validate failover behavior across all four tunnels.
