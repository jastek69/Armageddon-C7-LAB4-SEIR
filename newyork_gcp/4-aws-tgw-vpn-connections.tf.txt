# AWS VPN Setup = Transit Gateway (TGW) + Customer Gateways
# This replaces the legacy VGW-based config and attaches VPNs to the Tokyo TGW.
# Fill values from Tokyo stack outputs and GCP HA VPN gateway.

variable "aws_region" {
  description = "AWS region for TGW (Tokyo)"
  type        = string
  default     = "ap-northeast-1"
}

variable "tgw_id" {
  description = "Tokyo Transit Gateway ID"
  type        = string
  default     = ""
}

variable "aws_side_asn" {
  description = "AWS-side ASN (TGW BGP ASN)"
  type        = number
  default     = 65501
}

variable "gcp_peer_asn" {
  description = "GCP Cloud Router ASN"
  type        = number
  default     = 65515
}

variable "gcp_ha_vpn_public_ip_1" {
  description = "GCP HA VPN gateway interface 0 public IP"
  type        = string
}

variable "gcp_ha_vpn_public_ip_2" {
  description = "GCP HA VPN gateway interface 1 public IP"
  type        = string
}

variable "tunnel1_inside_cidr" { type = string }
variable "tunnel2_inside_cidr" { type = string }
variable "tunnel3_inside_cidr" { type = string }
variable "tunnel4_inside_cidr" { type = string }

variable "psk_tunnel_1" { type = string }
variable "psk_tunnel_2" { type = string }
variable "psk_tunnel_3" { type = string }
variable "psk_tunnel_4" { type = string }

variable "gcp_advertised_cidr" {
  description = "CIDR advertised from GCP Cloud Router toward AWS."
  type        = string
  default     = "10.240.0.0/16"
}

provider "aws" {
  region = var.aws_region
}

data "terraform_remote_state" "tokyo" {
  backend = "s3"
  config = {
    bucket = var.tokyo_state_bucket
    key    = var.tokyo_state_key
    region = var.tokyo_state_region
  }
}

locals {
  # Allow explicit override, otherwise read TGW ID from Tokyo state.
  effective_tgw_id = var.tgw_id != "" ? var.tgw_id : try(data.terraform_remote_state.tokyo.outputs.tokyo_transit_gateway_id, "")
}

resource "aws_customer_gateway" "gcp_cgw_1" {
  bgp_asn    = var.gcp_peer_asn
  ip_address = var.gcp_ha_vpn_public_ip_1
  type       = "ipsec.1"
  tags = { Name = "gcp-ha-vpn-if0" }
}

resource "aws_customer_gateway" "gcp_cgw_2" {
  bgp_asn    = var.gcp_peer_asn
  ip_address = var.gcp_ha_vpn_public_ip_2
  type       = "ipsec.1"
  tags = { Name = "gcp-ha-vpn-if1" }
}

resource "aws_vpn_connection" "tgw_vpn_1" {
  transit_gateway_id  = local.effective_tgw_id
  customer_gateway_id = aws_customer_gateway.gcp_cgw_1.id
  type                = "ipsec.1"
  static_routes_only  = false

  tunnel1_inside_cidr   = var.tunnel1_inside_cidr
  tunnel1_preshared_key = var.psk_tunnel_1
  tunnel1_ike_versions  = ["ikev2"]

  tunnel2_inside_cidr   = var.tunnel2_inside_cidr
  tunnel2_preshared_key = var.psk_tunnel_2
  tunnel2_ike_versions  = ["ikev2"]

  tags = { Name = "tgw-to-gcp-vpn-1" }
}

resource "aws_vpn_connection" "tgw_vpn_2" {
  transit_gateway_id  = local.effective_tgw_id
  customer_gateway_id = aws_customer_gateway.gcp_cgw_2.id
  type                = "ipsec.1"
  static_routes_only  = false

  tunnel1_inside_cidr   = var.tunnel3_inside_cidr
  tunnel1_preshared_key = var.psk_tunnel_3
  tunnel1_ike_versions  = ["ikev2"]

  tunnel2_inside_cidr   = var.tunnel4_inside_cidr
  tunnel2_preshared_key = var.psk_tunnel_4
  tunnel2_ike_versions  = ["ikev2"]

  tags = { Name = "tgw-to-gcp-vpn-2" }
}
# Canonical template file:
# - Use this file for AWS TGW <-> GCP VPN blueprint updates.
# - Legacy filename `newyork_gcp/4-aws-vpn-connections.tf.txt` is deprecated.
# -------------------------------------------------------------------
# Architecture Notes: AWS TGW <-> GCP HA VPN
# -------------------------------------------------------------------
# Required on AWS side for GCP connectivity:
# 1) aws_customer_gateway (2) -> one per GCP HA VPN public interface.
# 2) aws_vpn_connection (2) with transit_gateway_id -> each has two tunnels.
# 3) TGW route table association/propagation for VPN attachments.
# 4) Tokyo VPC route tables -> GCP CIDRs routed to TGW.
# 5) Security controls -> allow DB access from approved GCP CIDRs only.
#
# Not used for this integration:
# - aws_ec2_transit_gateway_peering_attachment (AWS TGW-to-TGW only)
# - aws_vpc_peering_connection (VPC peering, not IPSec VPN to GCP)
#
# Where tunnel info belongs:
# - AWS tunnel config goes in aws_vpn_connection:
#   tunnel*_inside_cidr, tunnel*_preshared_key, tunnel params.
# - AWS tunnel outside IPs are generated by AWS and consumed on GCP side.
# - GCP side mirrors the same PSKs and inside CIDRs in VPN tunnel/router blocks.
# -------------------------------------------------------------------
